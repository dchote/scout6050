<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Scout6050 Demo</title>
		<script type="text/javascript" src="mosquitto-1.1.js"></script>
		<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
	</head>
	<body>
		<div id="position">
			<div>Roll: <span id="rollValue">unknown</span></div>
			<div>Pitch: <span id="pitchValue">unknown</span></div>
			<div>Yaw: <span id="yawValue">unknown</span></div>
			<div>updates: <span id="totalPackets">0</span></div>
			<div>latency: <span id="latency">unknown</span></div>
			<div>voltage: <span id="batteryVoltage">unknown</span></div>
			<div>temp: <span id="temperature">unknown</span></div>
			
			<button onclick="startStream()">Start Stream</button>
			<button onclick="stopStream()">Stop Stream</button>
			<button onclick="sendPing()">Ping</button>
			<button onclick="requestHealth()">Health</button>
			
		</div>
		<div id="playarea">
			<div>Pitch: <span id="pitch">unknown</span></div>
			<div>Volume: <span id="volume">unknown</span></div>
			<div>Pan: <span id="pan">unknown</span></div>
			
			<button onclick="play()">Oscillate me</button>
			<button onclick="stop()">STAWP</button>
			
		</div>
		
		<script type="text/javascript">
			var queue = new Mosquitto();
			
			var url = 'ws://' + window.location.host + '/mqtt';
			
			var topic = 'dchote/scout6050';
			var controlTopic = 'dchote/scout6050-control';
			
			var position = null;
			var packets = 0;
			
			var audioContext, oscillator;
			
			var playing;
			
			$(document).ready(function() {
				try {
					audioContext = new (window.AudioContext || window.webkitAudioContext);
					
					oscillator = audioContext.createOscillator();
					oscillator.connect(audioContext.destination);
					
				} catch (e) {
					alert('No web audio oscillator support in this browser');
				}
				
				queue.connect(url, 10);
				
				queue.onconnect = function(rc) {
					if (rc == 0) {
						document.title = "Connected to " + url;
						
						queue.subscribe(topic, 0);
						
						document.title = document.title + ' (' + topic + ')';
						/*
						setInterval(function() {
							
						},5000);
						*/
					}
		        };
				
				queue.onmessage = function(topic, payload, qos) {
					if (payload.length < 3) {
						return;
					}
					
					try {
						var responsePacket = jQuery.parseJSON(payload);

						if (responsePacket.payload == 'position') {
							if (responsePacket && responsePacket.yaw) {
								updatePosition(responsePacket);
							}
						} else if (responsePacket.payload == 'pong') {
							var currentDate = new Date;
							var currentTime = currentDate.getTime();
							var pingTime = new Date(responsePacket.timestamp.substr(1));

							$('#latency').html = (currentTime - pingTime);
						} else if (responsePacket.payload == 'health') {
							$('#batteryVoltage').html(responsePacket.batteryVoltage);
							$('#temperature').html(responsePacket.temperature);
						}
					} catch (e) {
						console.log(e);
					}
					
				};
					
			});
			
			function updatePosition(newPosition) {
				position = newPosition;
				packets++;
				
				$('#yawValue').html(position.yaw);
				$('#pitchValue').html(position.pitch);
				$('#rollValue').html(position.roll);
				
				$('#totalPackets').html(packets);
				
				
				if (playing) {
					oscillator.frequency.value = position.yaw * 5;
				}

			}
			
			function sendPing() {
				var command = new Object();
				command.payload = 'pinger';
				
				var currentDate = new Date;
				//command.time = 't' + currentDate.getTime();
				//command.filler = 'random text';
				
				var commandString = JSON.stringify(command);
				queue.publish(controlTopic, commandString, 0, 0);
			}
			
			function requestHealth() {
				var command = new Object();
				command.payload = 'health';
				
				var commandString = JSON.stringify(command);
				queue.publish(controlTopic, commandString, 0, 0);
			}
			
			function startStream() {
				var command = new Object();
				command.payload = 'startStream';
				
				var commandString = JSON.stringify(command);
				queue.publish(controlTopic, commandString, 0, 0);
			}
			
			function stopStream() {
				var command = new Object();
				command.payload = 'stopStream';
				
				var commandString = JSON.stringify(command);
				queue.publish(controlTopic, commandString, 0, 0);
			}
			
			function stop() {
				playing = false;
				
				oscillator.noteOff(0);
			}

			function play() {
				playing = true;
				
				if (position.yaw != null) {
					oscillator.frequency.value = position.yaw * 5;
				} else {
					oscillator.frequency.value = 500;
				}
				
				oscillator.noteOn(0);
			}
		</script>
	</body>
</html>